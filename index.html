<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Control de Materiales</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1221; --text:#e5e7eb; --muted:#94a3b8;
    --border:#1f2937; --accent:#38bdf8; --accent2:#22d3ee;
    --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; color:var(--text);
       background: radial-gradient(1200px 600px at 10% -10%, #11203f 0%, transparent 60%),
                   radial-gradient(1000px 500px at 110% 10%, #12243f 0%, transparent 60%),
                   var(--bg);
       padding:18px}
  .app{max-width:1200px;margin:0 auto}
  h1{margin:0 0 14px;font-size:clamp(22px,3.2vw,32px)}
  .panel{background:linear-gradient(180deg,#0f1a2e,#0b1221); border:1px solid var(--border);
         border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
  .controls{display:grid; gap:12px}
  @media (min-width:760px){ .controls{ grid-template-columns:1.1fr 1.1fr 1fr; align-items:end } }
  label{display:block; font-size:14px; color:var(--muted); margin-bottom:6px}
  select,input[type="text"],input[type="number"]{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
    background:#0a1220; color:var(--text); outline:none;
  }
  select:focus,input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(56,189,248,.18) }
  .hint{color:var(--muted); font-size:12px; margin-top:6px}

  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center}
  button{border:1px solid var(--border); background:#0d1b31; color:var(--text);
         padding:10px 14px; border-radius:12px; cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--accent2),var(--accent)); color:#081320; font-weight:600}
  button:disabled{opacity:.6; cursor:not-allowed}

  /* Progreso */
  .progress{width:240px; height:10px; background:#0a1323; border:1px solid var(--border);
            border-radius:999px; overflow:hidden}
  .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--ok),var(--accent));
       transition:width .2s}

  /* Tabla */
  .table-wrap{overflow-x:auto; -webkit-overflow-scrolling:touch; margin-top:16px;
              border:1px solid var(--border); border-radius:14px}
  table{width:100%; border-collapse:separate; border-spacing:0; min-width:940px}
  thead th{position:sticky; top:0; z-index:2; background:#0e213a; color:#cfe7ff; padding:10px;
           border-bottom:1px solid var(--border)}
  tbody td{padding:8px; border-bottom:1px solid var(--border); text-align:center}
  tbody tr:hover{background:rgba(56,189,248,.08)}
  .left{text-align:left}
  .badge{display:inline-block; padding:4px 8px; border:1px solid var(--border);
         border-radius:999px; background:#0a1323; color:#cbd5e1; font-size:12px}

  /* Móvil: tarjetas con etiquetas */
  @media (max-width:640px){
    table{min-width:0}
    thead{display:none}
    tbody tr{display:block; padding:12px; border-bottom:1px solid var(--border)}
    tbody td{display:flex; justify-content:space-between; gap:10px; border:0; padding:8px 0}
    tbody td::before{content:attr(data-label); color:var(--muted); text-align:left}
    .table-wrap{border-radius:12px}
  }

  .errorCell{outline:2px solid var(--danger); outline-offset:2px; border-radius:8px}
  .msg{margin-top:8px; font-size:14px}
  .msg.error{color:var(--danger)}
  .msg.ok{color:var(--ok)}

  /* Modal */
  .modal{
    position:fixed; inset:0; background:rgba(0,0,0,.5);
    display:none; align-items:center; justify-content:center; padding:16px; z-index:50;
  }
  .modal.open{display:flex}
  .modal-card{
    width:min(680px, 100%); background:#0b1221; border:1px solid var(--border);
    border-radius:16px; box-shadow:var(--shadow); padding:16px;
  }
  .modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px}
  .modal-header h3{margin:0; font-size:18px}
  .modal-body{display:grid; gap:12px}
  .row{display:grid; gap:10px}
  @media (min-width:620px){ .row{ grid-template-columns:1fr 1fr 1fr } }
  .chips{display:flex; flex-wrap:wrap; gap:6px}
  .chip{background:#0a1323; border:1px solid var(--border); padding:4px 8px; border-radius:999px; font-size:12px}
  video{width:100%; border-radius:12px; border:1px solid var(--border)}
</style>
</head>
<body>
<div class="app">
  <h1>Control de Materiales</h1>

  <div class="panel">
    <div class="controls">
      <div>
        <label for="selIngeniero">Ingeniero que revisa</label>
        <select id="selIngeniero"><option value="">— Selecciona —</option></select>
        <div class="hint">Fuente: <b>Ingenieros</b> (columna B)</div>
      </div>

      <div>
        <label for="selCuadrilla">Cuadrilla</label>
        <select id="selCuadrilla" disabled><option value="">— Selecciona —</option></select>
        <div class="hint">Lista: pestaña <b>cuadrillas</b> (columna A)</div>
      </div>

      <div>
        <label for="filtro">Filtrar material</label>
        <input id="filtro" type="text" placeholder="Código o nombre…" disabled />
      </div>
    </div>

    <div class="actions">
      <div class="progress" title="Progreso de filas válidas marcadas">
        <div id="bar" class="bar"></div>
      </div>
      <span id="progTxt" class="hint">0/0</span>
      <button id="btnRegistrar" class="primary" disabled>Registrar seleccionados</button>
      <span id="status" class="msg"></span>
    </div>

    <div class="table-wrap">
      <table id="materialTable">
        <thead>
          <tr>
            <th>✔</th>
            <th>Cuadrilla</th>
            <th>Código</th>
            <th class="left">Nombre Material</th>
            <th>Físico Teórico</th>
            <th>Ingreso</th>
            <th>Cantidad</th>
            <th>Serie(s)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="8" style="text-align:center;color:#9ca3af;padding:14px">Selecciona Ingeniero y Cuadrilla…</td></tr>
        </tbody>
      </table>
    </div>
    <div class="hint">En móvil, cada fila se muestra como tarjeta con etiquetas.</div>
  </div>
</div>

<!-- Modal Series -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3>Ingreso de series</h3>
      <button id="mClose">✕</button>
    </div>
    <div class="modal-body">
      <div class="row">
        <div>
          <label>Método</label>
          <select id="mMetodo">
            <option value="uno">Manual 1×1</option>
            <option value="rango">Rango</option>
            <option value="scan">Escanear (cámara)</option>
          </select>
        </div>
        <div id="mUno" style="display:block">
          <label>Agregar serie</label>
          <input id="mSerie" type="text" placeholder="Ej: ABC123" />
          <div class="chips" id="mChips"></div>
        </div>
        <div id="mRango" style="display:none">
          <label>Prefijo</label>
          <input id="mPrefijo" type="text" placeholder="ABC" />
          <label>Inicio</label>
          <input id="mIni" type="number" inputmode="numeric" placeholder="1" />
          <label>Fin</label>
          <input id="mFin" type="number" inputmode="numeric" placeholder="50" />
        </div>
      </div>

      <div id="mScan" style="display:none">
        <label>Cámara</label>
        <video id="mVideo" playsinline></video>
        <div class="hint" id="mScanHint">Apunta al código. Añadirá cada lectura válida.</div>
      </div>

      <div style="display:flex; gap:8px; margin-top:10px">
        <button id="mAddUno">Agregar</button>
        <button id="mGenRango">Generar rango</button>
        <button id="mOk" class="primary">Usar series</button>
      </div>
    </div>
  </div>
</div>

<script>
  /* ===== CONFIG ===== */
  const SHEET_ID  = "1dtIWNjOyysVWy9Z0aIkygfwn2h6ihFXAp1nnZaQ8JXY";
  const API_KEY   = "AIzaSyAnPJKpsn34tTYdiKK0aiRW78r3NhQOx9s";

  // Pestañas
  const ING_SHEET        = "Ingenieros"; // B2:B
  const CUADRILLAS_SHEET = "cuadrillas"; // A2:A
  const MATERIALS_SHEET  = "base";       // A:I (min)

  // Índices en "base" (0-index)
  // A=0 Cuadrilla, B=1 Código, C=2 Nombre, D=3 TIPOMATERIAL, I=8 FISICO TEORICO
  const COL = { CUADRILLA:0, CODIGO:1, NOMBRE:2, TIPO:3, FIS_TEO:8 };

 
// ENDPOINT de Apps Script (ya desplegado como Web App)
const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbz2vjCOAoW8xlvVOnmTzfPWXzMAod3YFuPqBNBBBAIjL81d4f5Ac_gi2M7jTvkk6E0a/exec";


  /* ===== ELEMENTOS ===== */
  const selIngeniero = document.getElementById("selIngeniero");
  const selCuadrilla = document.getElementById("selCuadrilla");
  const filtro       = document.getElementById("filtro");
  const tbody        = document.querySelector("#materialTable tbody");
  const btnRegistrar = document.getElementById("btnRegistrar");
  const statusMsg    = document.getElementById("status");
  const bar          = document.getElementById("bar");
  const progTxt      = document.getElementById("progTxt");

  // Modal refs
  const modal = document.getElementById("modal");
  const mClose= document.getElementById("mClose");
  const mMetodo=document.getElementById("mMetodo");
  const mUno  = document.getElementById("mUno");
  const mRango= document.getElementById("mRango");
  const mScan = document.getElementById("mScan");
  const mSerie= document.getElementById("mSerie");
  const mChips= document.getElementById("mChips");
  const mPrefijo=document.getElementById("mPrefijo");
  const mIni  = document.getElementById("mIni");
  const mFin  = document.getElementById("mFin");
  const mAddUno=document.getElementById("mAddUno");
  const mGenRango=document.getElementById("mGenRango");
  const mOk   = document.getElementById("mOk");
  const mVideo= document.getElementById("mVideo");
  const mScanHint=document.getElementById("mScanHint");

  let materiales = []; // todos
  let cuadrillas = [];
  let hasUnsaved = false; // para aviso al recargar
  let targetSeriesInput = null; // input .series de la fila que abrió el modal
  let detector, camStream, chipSet = new Set(); // lector y colec. de series

  /* ===== INIT ===== */
  document.addEventListener("DOMContentLoaded", async () => {
    await loadIngenieros();
    await loadCuadrillas();
    await loadMateriales();
    updateControls();
  });

  // Aviso si hay cambios sin registrar
  window.addEventListener("beforeunload", (e)=>{
    if(hasUnsaved){
      e.preventDefault();
      e.returnValue = "";
    }
  });

  function markUnsaved(){ hasUnsaved = true; }
  function clearUnsaved(){ hasUnsaved = false; }

  async function gFetch(rangeA1){
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(rangeA1)}?key=${API_KEY}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status} al leer ${rangeA1}`);
    const data = await res.json();
    return data.values || [];
  }

async function loadIngenieros(){
  try{
    selIngeniero.innerHTML = '<option value="">Cargando…</option>';
    const v = await gFetch(ING_SHEET + '!B2:B');
    selIngeniero.innerHTML = '<option value="">— Selecciona —</option>';
    for (var i=0;i<v.length;i++){
      var r = v[i];
      var name = (r && r[0]) ? String(r[0]).trim() : "";
      if(name){
        var opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        selIngeniero.appendChild(opt);
      }
    }
    if(selIngeniero.options.length === 1){
      var opt2 = document.createElement('option');
      opt2.value = '';
      opt2.textContent = '(Sin datos en ' + ING_SHEET + '!B2:B)';
      selIngeniero.appendChild(opt2);
    }
  }catch(e){
    selIngeniero.innerHTML = '<option value="">(Error al cargar)</option>';
    console.error(e);
  }
}

async function loadCuadrillas(){
  try{
    selCuadrilla.innerHTML = '<option value="">Cargando…</option>';
    const v = await gFetch(CUADRILLAS_SHEET + '!A2:A');
    cuadrillas = [];
    for (var i=0;i<v.length;i++){
      var r = v[i];
      var val = (r && r[0]) ? String(r[0]).trim() : '';
      if(val){ cuadrillas.push(val); }
    }
    cuadrillas.sort(function(a,b){ return a.localeCompare(b,'es'); });
    selCuadrilla.innerHTML = '<option value="">— Selecciona —</option>';
    for (var j=0;j<cuadrillas.length;j++){
      var c = cuadrillas[j];
      var opt = document.createElement('option');
      opt.value = c; opt.textContent = c;
      selCuadrilla.appendChild(opt);
    }
    if(selCuadrilla.options.length === 1){
      var opt2 = document.createElement('option');
      opt2.value=''; opt2.textContent='(Sin datos en cuadrillas!A2:A)';
      selCuadrilla.appendChild(opt2);
    }
  }catch(e){
    selCuadrilla.innerHTML = '<option value="">(Error al cargar)</option>';
    console.error(e);
  }
}

  function updateControls(){
    const enabled = selIngeniero.value !== "";
    selCuadrilla.disabled = !enabled;
    filtro.disabled       = !enabled;
    btnRegistrar.disabled = !enabled;
    if(!enabled){
      tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#9ca3af;padding:14px">Selecciona Ingeniero…</td></tr>`;
    }
    updateProgress();
  }

  selIngeniero.addEventListener("change", ()=>{ updateControls(); clearTable("Elige una cuadrilla…"); });
  selCuadrilla.addEventListener("change", ()=>{ filtro.value=""; paintTable(); });
  filtro.addEventListener("input", paintTable);

  function clearTable(msg){
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#9ca3af;padding:14px">${msg}</td></tr>`;
    updateProgress();
  }

  function paintTable(){
  statusMsg.textContent = "";
  const ingOK = selIngeniero.value !== "";
  const cSel  = selCuadrilla.value;
  if(!ingOK){ clearTable("Selecciona Ingeniero."); return; }
  if(!cSel){  clearTable("Selecciona Cuadrilla."); return; }

  const q = (filtro.value || "").toLowerCase().trim();

  // Filtra SOLO por cuadrilla y (opcional) por texto
  const rows = materiales.filter(function(r){
    const cuadrillaVal = (r[COL.CUADRILLA] != null ? r[COL.CUADRILLA] : "").toString();
    const codigoVal    = (r[COL.CODIGO]    != null ? r[COL.CODIGO]    : "").toString();
    const nombreVal    = (r[COL.NOMBRE]    != null ? r[COL.NOMBRE]    : "").toString();

    if (cuadrillaVal !== cSel) return false;
    if (!q) return true;
    return codigoVal.toLowerCase().includes(q) || nombreVal.toLowerCase().includes(q);
  });

  if(rows.length === 0){
    clearTable("Sin materiales para esa cuadrilla.");
    return;
  }

  const frag = document.createDocumentFragment();
  tbody.innerHTML = "";

  rows.forEach(function(r){
    const cuadrillaTxt = (r[COL.CUADRILLA] != null ? r[COL.CUADRILLA] : "");
    const codigoTxt    = (r[COL.CODIGO]    != null ? r[COL.CODIGO]    : "");
    const nombreTxt    = (r[COL.NOMBRE]    != null ? r[COL.NOMBRE]    : "");
    const tipoTxt      = ((r[COL.TIPO]     != null ? r[COL.TIPO]      : "") + "").toLowerCase();
    const fisicoTeo    = (r[COL.FIS_TEO]   != null ? r[COL.FIS_TEO]   : "0").toString();

    const isSeriado = tipoTxt.indexOf("seriado") !== -1;
    const tr  = document.createElement("tr");

    tr.innerHTML = '' +
      '<td data-label="Incluir"><input type="checkbox" class="chk"></td>' +
      '<td data-label="Cuadrilla">' + cuadrillaTxt + '</td>' +
      '<td data-label="Código"><span class="badge"># ' + codigoTxt + '</span></td>' +
      '<td class="left" data-label="Nombre">' + nombreTxt + '</td>' +
      '<td data-label="Físico Teórico">' + fisicoTeo + '</td>' +
      '<td data-label="Ingreso">' +
        '<select class="modo" ' + (!isSeriado ? 'disabled title="Solo cantidad (No Seriado)"' : '') + '>' +
          (isSeriado
            ? '<option value="cantidad">Cantidad</option><option value="serie">Serie</option>'
            : '<option value="cantidad" selected>Cantidad</option>') +
        '</select>' +
      '</td>' +
      '<td data-label="Cantidad"><input type="number" class="cant" inputmode="decimal" min="0" step="any" placeholder="0"></td>' +
      '<td data-label="Serie(s)"><input type="text" class="series" placeholder="Ej: ABC123,ABC124" ' + (isSeriado ? '' : 'disabled') + '></td>';

    const modo = tr.querySelector(".modo");
    const cant = tr.querySelector(".cant");
    const ser  = tr.querySelector(".series");

    if(isSeriado){
      modo.addEventListener("change", function(){
        if(modo.value === "serie"){
          targetSeriesInput = ser;
          openSeriesWizard();
        }else{
          ser.value = "";
        }
        updateProgress(); markUnsaved();
      });
    }

    tr.querySelector(".chk").addEventListener("change", function(){ updateProgress(); markUnsaved(); });
    cant.addEventListener("input", function(){ updateProgress(); markUnsaved(); });
    ser.addEventListener("input",  function(){ updateProgress(); markUnsaved(); });

    frag.appendChild(tr);
  });

  tbody.appendChild(frag);
  updateProgress();
}

  }

function updateProgress(){
  const rows = Array.from(tbody.querySelectorAll("tr"));
  let checked = 0, valid = 0;

  rows.forEach(function(tr){
    const chk = tr.querySelector(".chk");
    if(!chk) return;
    if(chk.checked){
      checked++;
      const modoEl = tr.querySelector(".modo");
      const modo = (modoEl && modoEl.value) ? modoEl.value : "cantidad";
      const cant = tr.querySelector(".cant");
      const ser  = tr.querySelector(".series");
      const seriadoEnabled = ser ? !ser.disabled : false;

      let ok = false;
      if(seriadoEnabled && modo === "serie"){
        const sval = ser && ser.value ? ser.value.trim() : "";
        ok = !!sval;
      }else{
        const v = cant && cant.value ? parseFloat(cant.value) : NaN;
        ok = v > 0;
      }
      if(ok) valid++;
    }
  });

  const pct = checked ? Math.round((valid/checked)*100) : 0;
  bar.style.width = (checked ? pct : 0) + "%";
  progTxt.textContent = valid + "/" + checked;
}


  // ===== Modal Series =====
  function openSeriesWizard(){
    chipSet.clear(); renderChips();
    mSerie.value = ""; mPrefijo.value=""; mIni.value=""; mFin.value="";
    mMetodo.value="uno";
    mUno.style.display="block"; mRango.style.display="none"; mScan.style.display="none";
    modal.classList.add("open");
    startScanner(false);
  }
  function closeSeriesWizard(){
    modal.classList.remove("open");
    startScanner(false); // detener
  }
  mClose.addEventListener("click", closeSeriesWizard);
  modal.addEventListener("click", (e)=>{ if(e.target===modal) closeSeriesWizard(); });

  mMetodo.addEventListener("change", ()=>{
    const v = mMetodo.value;
    mUno.style.display   = v==="uno"   ? "block":"none";
    mRango.style.display = v==="rango" ? "block":"none";
    mScan.style.display  = v==="scan"  ? "block":"none";
    startScanner(v==="scan");
  });

  mAddUno.addEventListener("click", ()=>{
    const s = (mSerie.value||"").trim();
    if(!s) return;
    chipSet.add(s);
    mSerie.value=""; renderChips();
  });

  mGenRango.addEventListener("click", ()=>{
    const p = (mPrefijo.value||"");
    const ini = parseInt(mIni.value,10);
    const fin = parseInt(mFin.value,10);
    if(!(ini>=0) || !(fin>=ini)) return;
    const width = Math.max(mIni.value.length, mFin.value.length); // ceros a la izq
    for(let n=ini; n<=fin; n++){
      const num = String(n).padStart(width,"0");
      chipSet.add(`${p}${num}`);
    }
    renderChips();
  });

  function renderChips(){
    mChips.innerHTML = "";
    chipSet.forEach(val=>{
      const span = document.createElement("span");
      span.className="chip"; span.textContent = val;
      mChips.appendChild(span);
    });
  }

  mOk.addEventListener("click", ()=>{
    const list = Array.from(chipSet);
    if(targetSeriesInput){
      targetSeriesInput.value = list.join(",");
      updateProgress(); markUnsaved();
    }
    closeSeriesWizard();
  });

  // Escáner con BarcodeDetector (si existe)
  async function startScanner(on){
    try{
      if(!on){
        if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
        return;
      }
      if(!('BarcodeDetector' in window)){
        mScanHint.textContent = "Tu navegador no soporta BarcodeDetector. Usa Manual 1×1 o Rango.";
        return;
      }
      if(!detector){
        detector = new BarcodeDetector({ formats: ['code_128','qr_code','ean_13','ean_8','code_39','upc_a','upc_e'] });
      }
      camStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
      mVideo.srcObject = camStream; await mVideo.play();
      mScanHint.textContent = "Apunta al código. Se añadirá automáticamente.";
      scanLoop();
    }catch(e){
      console.error(e);
      mScanHint.textContent = "No se pudo abrir la cámara. Permite el acceso o usa otro método.";
    }
  }

  async function scanLoop(){
    if(!detector || !mVideo.srcObject) return;
    try{
      const codes = await detector.detect(mVideo);
      if(codes && codes.length){
        codes.forEach(c=> chipSet.add((c.rawValue||"").trim()));
        renderChips();
      }
    }catch(e){ /* ignore */ }
    requestAnimationFrame(scanLoop);
  }

  // ===== Registrar (igual que antes, con aviso de no perder datos) =====
  btnRegistrar.addEventListener("click", async ()=>{
  statusMsg.textContent = "";
  const rows = Array.from(tbody.querySelectorAll("tr"));
  if(rows.length===0){ return; }

  const errores = [];
  const registros = [];
  const filaIndexMap = []; // para mapear índice del payload -> <tr>

  rows.forEach((tr, idxInDom)=>{
    const chk   = tr.querySelector(".chk");
    if(!chk || !chk.checked) return;

    const cuadr = tr.children[1]?.innerText?.trim();
    const cod   = tr.children[2]?.innerText?.replace("#","").trim();
    const nom   = tr.children[3]?.innerText?.trim();
    const modo  = tr.querySelector(".modo")?.value || "cantidad";
    const cant  = tr.querySelector(".cant");
    const ser   = tr.querySelector(".series");
    const seriadoEnabled = !ser.disabled;

    // limpia estilos
    cant.classList.remove("errorCell");
    ser.classList.remove("errorCell");

    if(seriadoEnabled && modo==="serie"){
      const val = (ser.value||"").trim();
      if(!val){ ser.classList.add("errorCell"); errores.push(`Serie(s) faltante(s) para ${cod} – ${nom}`); return; }
      registros.push({cuadrilla:cuadr, reviso: selIngeniero.value, codigo:cod, cantidad:"", seriado:"Y", serie:val, fecha:new Date().toISOString()});
      filaIndexMap.push(idxInDom);
    }else{
      const val = parseFloat(cant.value);
      if(!(val>0)){ cant.classList.add("errorCell"); errores.push(`Cantidad faltante para ${cod} – ${nom}`); return; }
      registros.push({cuadrilla:cuadr, reviso: selIngeniero.value, codigo:cod, cantidad:val, seriado:"N", serie:"", fecha:new Date().toISOString()});
      filaIndexMap.push(idxInDom);
    }
  });

  if(errores.length){
    statusMsg.className="msg error";
    statusMsg.textContent = `Revisa: ${errores.join(" • ")}`;
    return;
  }
  if(registros.length===0){
    statusMsg.className="msg error";
    statusMsg.textContent = "No marcaste ninguna fila para registrar.";
    return;
  }

  try{
    btnRegistrar.disabled = true;
    statusMsg.className="msg";
    statusMsg.textContent = "Enviando…";

    const resp = await fetch(ENDPOINT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ registros })
    });

    const data = await resp.json().catch(()=>({ ok:false, error:"Respuesta inválida" }));

    // Limpia marcas previas
rows.forEach(tr=>{
  tr.querySelector(".cant")?.classList.remove("errorCell");
  tr.querySelector(".series")?.classList.remove("errorCell");
});

let firstBad = null;
data.errors.forEach(function(e){
  const domIndex = filaIndexMap[e.index];
  const tr = rows[domIndex];
  if(!tr) return;
  const cant = tr.querySelector(".cant");
  const ser  = tr.querySelector(".series");
  if(e.errors && e.errors.cantidad){ if(cant){ cant.classList.add("errorCell"); } firstBad = firstBad || cant; }
  if(e.errors && e.errors.serie){    if(ser){  ser.classList.add("errorCell"); }  firstBad = firstBad || ser; }
  if(e.errors && (e.errors.cuadrilla || e.errors.codigo || e.errors.reviso)){
    tr.classList.add("errorCell"); firstBad = firstBad || tr;
  }
});
if(firstBad && firstBad.scrollIntoView){ firstBad.scrollIntoView({behavior:"smooth", block:"center"}); }

    // Éxito
    statusMsg.className="msg ok";
    statusMsg.textContent = `Registrado correctamente: ${data.saved ?? registros.length} fila(s).`;
    bar.style.width = "0%"; progTxt.textContent = "0/0";
    // Desmarcar seleccionados y limpiar campos
    rows.forEach(tr=>{
      const chk = tr.querySelector(".chk");
      if(chk && chk.checked){
        chk.checked = false;
var ci = tr.querySelector(".cant");   if(ci){ ci.value = ""; }
var si = tr.querySelector(".series"); if(si){ si.value = ""; }

      }
    });
    // ya no avisamos al salir
    hasUnsaved = false;

  }catch(e){
    console.error(e);
    statusMsg.className="msg error";
    statusMsg.textContent = "Error de red al registrar.";
  }finally{
    btnRegistrar.disabled = false;
    updateProgress();
  }
});

</script>
</body>
</html>
